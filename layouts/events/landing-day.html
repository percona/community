{{ define "css" -}}
  {{- .Page.Scratch.Add "css" (partial "scss" (dict "file" "scss/single.scss") | safeCSS) -}}
  {{- if in .Content "<pre class=\"chroma\">" -}}
    {{- .Page.Scratch.Add "css" (partial "scss" (dict "file" "scss/code.scss") | safeCSS) -}}
  {{ end }}
  {{- .Page.Scratch.Add "css" (partial "scss" (dict "file" "scss/landing.scss") | safeCSS) -}}
{{- end }}

{{ define "meta" }}

  {{/* Authors */}}
  {{- if (isset .Params "speakers") -}}
    {{ range $key, $author := .Params.speakers -}}
      {{- with $.Site.GetPage (print "/contributors/" $author) -}}
        <meta name="author" content="{{ .Params.fullname }}" />
      {{- end }}
    {{- end -}}
  {{- end -}}

  <link href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.min.css" rel="stylesheet"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.min.js"></script>

  {{/* Load JSON */}}
  {{ $json := resources.Get .Params.json }}
  {{ $data := $json | transform.Unmarshal }}
  {{ $Talks := $data.talks }}

  {{ $day := .Params.json_filter }}

    {{ range $Talks }}
    {{ if eq .Date $day }}
        <meta type="talk"
            title="{{ .Title }}"
            speaker1="{{ index . "Speaker 1" }}"
            company1="{{ index . "Company 1" }}"
            bio1="{{ index . "Bio 1" }}"
            speaker2="{{ index . "Speaker 2" }}"
            company2="{{ index . "Company 2" }}"
            bio2="{{ index . "Bio 2" }}"
            description="{{ .Description }}"
            date="{{ .Date }}"
            time="{{ index . "Sorting time" }}"
            time1="{{ index . "Time Start EDT" }}"
            time2="{{ index . "Time Start CEST" }}"
        />
    {{ end }}
    {{ end }}

{{ end }}

{{ define "main" }}

<div class="landing text">

    <h1 class="landing__title">{{ .Title }}</h1>

    <div class="body">
      {{ partial "content.html" . }}
    </div>

    <h2 id="agenda">Agenda</h2>

    <table id="example2" class="display landing__table" style="width:100%">
        <thead>
            <tr>
                <th width="3%"></th>
                <th width="40%">Talk</th>
                <th>Speaker</th>
                <th width="12%">Time EDT</th>
                <th width="12%">Time CEST</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    {{/* JS restored and adapted */}}
    <script type="text/javascript">

        function format(d) {
            let html = '<div class="landing-table__description"><p>';

            if (d.description) html += d.description + '<br/><br/>';

            if (d.speaker1) {
                html += '<span class="landing-table__speaker">' +
                        d.speaker1 + ' (' + d.company1 + ')</span><br/>' +
                        d.bio1;
            }

            if (d.speaker2) {
                html += '<br/><br/><span class="landing-table__speaker">' +
                        d.speaker2 + ' (' + d.company2 + ')</span><br/>' +
                        d.bio2;
            }

            html += '</p></div>';
            return html;
        }

        function Talk(meta) {
            this.title = meta.getAttribute("title");
            this.speaker1 = meta.getAttribute("speaker1");
            this.company1 = meta.getAttribute("company1");
            this.bio1 = meta.getAttribute("bio1");
            this.speaker2 = meta.getAttribute("speaker2");
            this.company2 = meta.getAttribute("company2");
            this.bio2 = meta.getAttribute("bio2");
            this.description = meta.getAttribute("description");
            this.time1 = meta.getAttribute("time1");
            this.time2 = meta.getAttribute("time2");

            if (this.speaker2) {
                this.speakersHtml =
                    '<b>' + this.speaker1 + '</b> (' + this.company1 + '),<br/>' +
                    '<b>' + this.speaker2 + '</b> (' + this.company2 + ')';
            } else {
                this.speakersHtml =
                    '<b>' + this.speaker1 + '</b> (' + this.company1 + ')';
            }

            this.titleHtml = this.title;
        }

        $(document).ready(function () {

            const metas = document.querySelectorAll('meta[type="talk"]');
            const data_obj = [...metas].map(m => new Talk(m));

            const table = $('#example2').DataTable({
                data: data_obj,
                columns: [
                    {
                        className: 'dt-control',
                        orderable: false,
                        data: null,
                        defaultContent: '',
                    },
                    { data: 'titleHtml' },
                    { data: 'speakersHtml' },
                    { data: 'time1' },
                    { data: 'time2' }
                ],
                order: [[4, 'asc']],
                paging: false
            });

            $('#example2 tbody').on('click', 'td.dt-control', function () {
                const tr = $(this).closest('tr');
                const row = table.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                } else {
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });
        });

    </script>

    <div class="video">
        {{ partial "video.html" . }} 
    </div>

</div>

<div class="landing">

    <h2 id="talks">Talks</h2>

    <div class="grid grid--2">
        {{ range where $.Site.Pages "Params.day" .Params.json_filter }}
            <div class="grid__item">
                {{ partial "talkpreview" (dict
                    "Link" .RelPermalink
                    "Title" .Title
                    "Image" (index .Params.images 0)
                    "Content" .Params.description
                ) }}
            </div>
        {{ end }}
    </div>

    {{ if (isset .Params "speakers")}}
    <h2 id="speakers">Speakers</h2>
    <div class="grid grid--4 speakers">
        {{ range $key, $author := .Params.speakers }}
          {{ with $.Site.GetPage (print "/contributors/" $author) }}
            <div class="grid__item speaker">
               {{ partial "speakerpreview" (dict
                    "Link" .RelPermalink
                    "Name" .Params.fullname
                    "Image" (index .Params.images 0)
                    "Content" .Content
                    "Job" .Params.job
               ) }}
            </div>
          {{ end }}
        {{ end }}
    </div>
    {{ end }}

    <h2 id="days">Days</h2>

    <div class="grid grid--2">
        {{ range where $.Site.Pages "Params.layout" "landing-day" }}
            <div class="grid__item">
                {{ partial "talkpreview" (dict
                    "Link" .RelPermalink
                    "Title" .Title
                    "Image" (index .Params.images 0)
                    "Content" .Params.description
                ) }}
            </div>
        {{ end }}
    </div>

</div>

<br/><br/>
{{ partial "sharing.html" . }}
<br/><br/>

{{ end }}
